<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Store Selection Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .test-btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .console-output { background: #000; color: #00ff00; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>🔍 Tenant Store Selection Flow - Debug Test</h1>
    
    <div class="test-section info">
        <h2>🎯 Testing Navigation Loop Fix</h2>
        <p><strong>Issue:</strong> After selecting organization and store, user navigates to /dashboard but gets redirected back to /tenant-store-selection</p>
        <p><strong>Root Cause:</strong> State persistence issue with Zustand store and timing of state updates</p>
    </div>
    
    <div class="test-section">
        <h2>🧪 Test Steps</h2>
        <ol>
            <li><strong>Open Application:</strong> <a href="http://localhost:5174/" target="_blank">http://localhost:5174/</a></li>
            <li><strong>Check Redirect:</strong> Should go to signin (if not authenticated)</li>
            <li><strong>Sign In:</strong> Complete authentication</li>
            <li><strong>Tenant Selection:</strong> Should show "Select Organization" step</li>
            <li><strong>Select Organization:</strong> Click on an organization card</li>
            <li><strong>Store Selection:</strong> Should automatically move to "Select Store" step</li>
            <li><strong>Select Store:</strong> Click on a store card</li>
            <li><strong>Navigation:</strong> Should navigate to dashboard and STAY there</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>🔧 Debug Information</h2>
        <p>Open browser console to see debug output:</p>
        <ul>
            <li><code>🔄 Initializing TenantStoreSelection</code> - Component initialization</li>
            <li><code>🔍 Navigation Effect</code> - State changes and navigation decisions</li>
            <li><code>🔍 ProtectedRoute Check</code> - Route protection validation</li>
            <li><code>✅ Both tenant and store selected</code> - Successful selection</li>
            <li><code>❌ Missing tenant or store</code> - Failed validation</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>📊 Expected Behavior</h2>
        <div class="success">
            <h3>✅ Success Flow:</h3>
            <p>Login → Tenant Selection → Store Selection → Dashboard (NO LOOP)</p>
        </div>
        <div class="error">
            <h3>❌ Previous Issue:</h3>
            <p>Login → Tenant Selection → Store Selection → Dashboard → BACK to Tenant Selection (LOOP)</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>🛠️ Applied Fixes</h2>
        <ul>
            <li><strong>Clear State on Init:</strong> Always clear tenant/store selections when arriving at selection page</li>
            <li><strong>Initialization Flag:</strong> Prevent re-initialization loops with hasInitialized flag</li>
            <li><strong>Navigation Delay:</strong> Added 200ms delay to ensure state persistence before navigation</li>
            <li><strong>Proper State Methods:</strong> Use clearSelection() instead of switchTenant('')</li>
            <li><strong>Debug Logging:</strong> Added comprehensive console logging for troubleshooting</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>🚀 Quick Test Buttons</h2>
        <button class="test-btn" onclick="window.open('http://localhost:5174/', '_blank')">Open App</button>
        <button class="test-btn" onclick="window.open('http://localhost:5174/dashboard', '_blank')">Test Dashboard Direct</button>
        <button class="test-btn" onclick="window.open('http://localhost:5174/tenant-store-selection', '_blank')">Test Selection Page</button>
        <button class="test-btn" onclick="clearLocalStorage()">Clear Local Storage</button>
    </div>
    
    <div class="test-section">
        <h2>📱 Local Storage Debug</h2>
        <button class="test-btn" onclick="showLocalStorage()">Show Current State</button>
        <div id="storage-output" class="console-output" style="margin-top: 10px; min-height: 100px;"></div>
    </div>
    
    <script>
        function clearLocalStorage() {
            localStorage.removeItem('tenant-storage');
            alert('Local storage cleared! The app should now start fresh.');
        }
        
        function showLocalStorage() {
            const output = document.getElementById('storage-output');
            const tenantStorage = localStorage.getItem('tenant-storage');
            
            if (tenantStorage) {
                try {
                    const parsed = JSON.parse(tenantStorage);
                    output.innerHTML = `
                        <div>🗄️ tenant-storage contents:</div>
                        <div>Current Tenant: ${parsed.state?.currentTenant ? parsed.state.currentTenant.name + ' (' + parsed.state.currentTenant.id + ')' : 'None'}</div>
                        <div>Current Store: ${parsed.state?.currentStore ? parsed.state.currentStore.store_name + ' (' + parsed.state.currentStore.store_id + ')' : 'None'}</div>
                        <div>Tenants Count: ${parsed.state?.tenants ? parsed.state.tenants.length : 0}</div>
                        <pre>${JSON.stringify(parsed, null, 2)}</pre>
                    `;
                } catch (e) {
                    output.innerHTML = `<div>❌ Error parsing storage: ${e.message}</div><pre>${tenantStorage}</pre>`;
                }
            } else {
                output.innerHTML = '<div>🗃️ No tenant-storage found in localStorage</div>';
            }
        }
        
        // Auto-refresh storage display every 2 seconds
        setInterval(showLocalStorage, 2000);
        showLocalStorage(); // Initial load
    </script>
</body>
</html>
